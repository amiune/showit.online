<!doctype html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ShowIt.Online</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@next/css/pico.min.css" />
    <style>
	  header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header nav ul {
      margin: 0;
    }
	  main {
      margin-top: 2rem;
      text-align: center;
      max-width: 800px;
    }
	  .hero p{
	  max-width: 600px;
	  margin: 0 auto;
	  }
	  .form{
	     margin-top: 1rem;
	  }
    footer {
      text-align: center;
      margin-top: 2rem;
    }
	  #outputURLSection{
	      margin-top: 1rem;
	  }

    /* Beautify the index tree */
    ul.tree {
      list-style: none;
      padding-left: 0;
      margin: 50px 0 0 0;
    }

    ul.tree ul {
      list-style: none;
      padding-left: 1rem;
      margin: 0;
    }

    ul.tree li {
      margin: 0.4rem 0;
      list-style: none;
    }

    summary {
      list-style: none;
    }

    ul.tree li > details > summary {
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      color: var(--primary);
      list-style: none;
    }

    ul.tree li > details > summary::before {
      content: "üìÅ ";
    }

    ul.tree a {
      text-decoration: none;
      font-weight: 500;
      transition: background 0.2s, color 0.2s;
    }

    ul.tree a::before {
      content: "üìÑ ";
    }

    details > ul {
      margin-left: 0.5rem;
      padding-left: 0;
    }

    .summary-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
      font-size: 1rem;
      color: var(--primary);
    }
    </style>
  </head>
  <body>

  <div id="content" style="display:none">
	  <header class="container">
      <a href="/" class="contrast">ShowIt.Online</a>
      <nav>
        <ul>
          <li><a href="faq.html">FAQ</a></li>
          <li><a href="contact.html">Ask 4a feature</a></li>
        </ul>
      </nav>
    </header>
	
	  <main class="container">
      <div class="hero">
			<h1>A pretty and easy way to share markdown files</h1>
			<p>
			Just copy and paste the url of your markdown file from github and get a url to share it in a pretty and easy way. 
			Ideal to share study notes, creating a landing page or even a mini website.
			</p>
			<p>‚úîÔ∏è No ads and free forever (<a href="faq.html">why and how?</a>)</p>
      <p>‚úîÔ∏è Open Source (<a href="https://github.com/amiune/showit.online">read the code</a>)</p>
	    </div>

      <div class="form">
			<input id="githubusername" type="text" placeholder="Your GitHub username, like: amiune" value="amiune" />
      <input id="githubrepo" type="text" placeholder="Your GitHub repo, like: showit.online" value="nano-blog" />
			<button id="encodeButton">Create my URL to share</button>
			<div id="outputURLSection" style="display:none">
				<label for="outputEncodedString" >
					Share this URL with anyone you want:
					<textarea id="outputEncodedString" readonly="" placeholder=""></textarea>
				</label>
        <button id="copyUrlButton">Copy url to clipboard</button>
			</div>
		  <div>
	  
    </main>

    <footer class="container">
      <small>&copy; <span id="currentYear"></span> ShowIt.Online All rights reserved.</small>
    </footer>
	</div>

  <div id="loading">
    <section>
          <div id="content">
            <section id="progress">
              <h1>Loading Content</h1>
              <progress id="progress-2"></progress>
            </section>
          </div>
        </section>
  </div>

	<script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/notebookjs@0.8.3/notebook.min.js"></script>
	<script>

    // This use https://github.com/jsvine/notebookjs to render Jupyter Notebooks
    // and https://github.com/markdown-it/markdown-it to render markdown files.
    // TODO: try https://github.com/markedjs/marked/

    // --- Global Variables ---
    var GITHUB_USER = "";
    var GITHUB_REPO = "";
    var GITHUB_REPO_BRANCH = "";
    var BASE_URL = "";

    // --- UI Elements and Event Listeners ---
    // Get references to all necessary DOM elements
    const content = document.getElementById('content');
    const githubusername = document.getElementById('githubusername');
    const githubrepo = document.getElementById('githubrepo');
    const encodeButton = document.getElementById('encodeButton');
    const outputEncodedString = document.getElementById('outputEncodedString');
    const outputURLSection = document.getElementById('outputURLSection');
    const copyUrlButton = document.getElementById('copyUrlButton');
    document.getElementById('currentYear').innerHTML = new Date().getFullYear();


    // Event listener for the Encode button click
    // This will encode the input string and display the encoded URL
    encodeButton.addEventListener('click', () => {
      //const str = inputString.value.trim(); // Get and trim the input string
      const githubUsernameValue = githubusername.value.trim();
      const githubRepoValue = githubrepo.value.trim();
      if (githubUsernameValue && githubRepoValue) {
        // Use encodeURIComponent for URL-safe encoding
        //var encoded = encodeURIComponent(str);
        //encoded = "https://showit.online/#!url=" + encoded;
        //outputEncodedString.value = encoded; // Display the encoded string

        var encoded = encodeURIComponent(githubUsernameValue + "/" + githubRepoValue);
        outputEncodedString.value = "https://showit.online/#!ghrepo=" + encoded;
        outputURLSection.style.display = "block";
      }
    });

    // Event listener for the Copy URL button click
    // This will copy the encoded URL to the clipboard
    copyUrlButton.addEventListener('click', () => {
            const textarea = document.getElementById('outputEncodedString');
            textarea.select();
            textarea.setSelectionRange(0, 99999); // For mobile devices

            try {
                const successful = document.execCommand('copy');
                const msg = successful ? 'URL copied successfully!' : 'Failed to copy URL.';
                copyUrlButton.innerText = msg;
            } catch (err) {
                copyUrlButton.innerText = "Error when copying the url.";
            }
    });

    function slug_to_title(slug) {
      // The first part of the slug is used to save the date
      // this allows to order the posts
      slug = slug.substring(slug.indexOf("-")+1);
      let words = slug.split('-');
      for (let i = 0; i < words.length; i++) {
        let word = words[i];
        words[i] = word.charAt(0).toUpperCase() + word.slice(1);
      }
      return words.join(' ');
    }

    // helper function to validate if a string is a valid URL
    function isValidUrl(urlString) {
      try {
        new URL(urlString); // Attempt to create a URL object
        return true; // If successful, it's a valid URL
      } catch (e) {
        return false; // If it throws an error, it's not a valid URL
      }
    }

    // Replace the loading screen for the content
    function showContent(){
      content.style.display = "block";
      document.getElementById('loading').style.display = "none";
    }

    // Function to handle the 404 error
    // This will set the meta robots tag to noindex and display a 404 message
    function showError404() {
      // Error 404
      // https://developers.google.com/search/docs/crawling-indexing/javascript/javascript-seo-basics
      const metaRobots = document.createElement('meta');
      metaRobots.name = 'robots';
      metaRobots.content = 'noindex';
      document.head.appendChild(metaRobots);
      content.innerHTML = "<h1>404: Page not found</h1>";
      showContent();
    }

    // Function to load a markdown file and display its content
    function loadMarkdownContent(url) {
      if(isValidUrl(url)){
        fetch(url).then(async (response) => {
          if (response.ok) {
            text = await response.text();
            let md = window.markdownit();
            content.innerHTML = md.render(text);
            showContent();
          }
          else{
            showError404();
          }
        });
      }
      else{
        showError404();
      }
    }

    function fileFilter(item) {
      return item.type === 'blob' && (item.path.endsWith('.md') || item.path.endsWith('.ipynb'));
    }

    async function getAllRepoFiles(owner, repo) {
      // 1. Get the branch to find the latest commit SHA
      const branchUrl = `https://api.github.com/repos/${owner}/${repo}/branches`;
      const refRes = await fetch(branchUrl);
      if (!refRes.ok) throw new Error(`Failed to fetch branch: ${refRes.status}`);
      const refData = await refRes.json();
      const treeSha = refData[0].commit.sha;
      console.log(`Branch: ${refData[0].name}, Tree SHA: ${treeSha}`);
      GITHUB_REPO_BRANCH = refData[0].name; // Update global variable with the branch name

      // 2. Get the tree recursively
      const treeUrl = `https://api.github.com/repos/${owner}/${repo}/git/trees/${treeSha}?recursive=1`;
      const treeRes = await fetch(treeUrl);
      if (!treeRes.ok) throw new Error(`Failed to fetch tree: ${treeRes.status}`);
      // 3. Get only file entries (type === 'blob')
      const treeData = await treeRes.json();
      const files = treeData.tree.filter(fileFilter);

      return files; // Includes path, sha, url, size, etc.
    }

    function buildNestedDict(paths) {
      const result = {};
      for (const path of paths) {
        const keys = path.path.split("/");
        let current = result;

        for (const key of keys) {
          if (!(key in current)) {
            current[key] = {};
          }
          current = current[key];
        }
      }
      return result;
    }

    function dictToCollapsibleHTML(obj, path = "") {
      let html = '<ul class="tree">';

      for (const key in obj) {
        const currentPath = path ? `${path}/${key}` : key;

        if (Object.keys(obj[key]).length === 0) {
          // Leaf node: use <a> inside <li>
          const githubRawUrl = BASE_URL + encodeURIComponent(currentPath);
          html += `<li><a href="${githubRawUrl}">${key}</a></li>`;
        } else {
          // Non-leaf node: use <details><summary>...</summary><ul>...</ul></details>
          html += `
            <li>
              <details>
                <summary class="summary-label">${key}</summary>
                ${dictToCollapsibleHTML(obj[key], currentPath)}
              </details>
            </li>
          `;
        }
      }

      html += "</ul>";
      return html;
    }


    function loadGitHubRepo(repoUrl) {
      var tmp = repoUrl.split("/");
      GITHUB_USER = tmp[0];
      GITHUB_REPO = tmp[1];
      // Show blog list of posts
      
      const REVERSE_ORDER = false;
      const REPO_TITLE = GITHUB_REPO + " by " + GITHUB_USER;
      getAllRepoFiles(GITHUB_USER, GITHUB_REPO)
        .then((files) => {
            BASE_URL = `https://showit.online/#!url=https%3A%2F%2Fraw.githubusercontent.com%2F${GITHUB_USER}%2F${GITHUB_REPO}%2Frefs%2Fheads%2F${GITHUB_REPO_BRANCH}%2F`;
            if(REVERSE_ORDER)files.reverse();
            let htmlList = "";
            var dictOfFiles = buildNestedDict(files);
            htmlList = dictToCollapsibleHTML(dictOfFiles);
            document.title = REPO_TITLE;
            // Create a div to hold the title and list
            let div = "<div><h1>" + REPO_TITLE + "</h1>" + htmlList + "</div>";
            document.getElementById('content').innerHTML = div;
            showContent();
        });
    }


    // Function to reload the page and fetch content based on the URL
    function reload_page(){
      var url = window.location.href;
      if(url.includes("#!")){
        content.style.margin = "4rem";
        const queryParams = new URLSearchParams(url.split("#!")[1]);
        if (queryParams.has("ghrepo")) {
          var repoUrl = queryParams.get("ghrepo");
          repoUrl = decodeURIComponent(repoUrl);
          loadGitHubRepo(repoUrl);
        }
        else if (queryParams.has("url") === false) {
          var decodedUrl = decodeURIComponent(queryParams.get("url"));
          loadMarkdownContent(decodedUrl);
        }
      }
      else{
        showContent();
      }
    };

    window.addEventListener('popstate', function (event) {
      reload_page();
    });

    reload_page();

  </script>

  </body>
</html>
